<!DOCTYPE html>
<html>

<head>
    <style>
        * {
            box-sizing: border-box;
        }

        div#editor {
            display: flex;
        }

        div.row {
            font-size: 0;
            line-height: 34px;
            height: 34px;
            margin-left: auto;
            margin-right: auto;
        }

        div.cell {
            display: inline-block;
            width: 34px;
            height: 34px;
            margin: 0;
            padding: 0;
            background-color: lightgray;
            border: 1px solid #dcdcdc;
            cursor: pointer;
            position: relative;
        }

        div.cell.walkable {
            background-color: black;
        }

        div.cell.water {
            background-color: darkslateblue;
        }

        div.cell.selected {
            border: 2px solid #000;
        }


        div.cell.p1 {
            background-image: url("/static/robot.png");
            background-size: 32px;
            image-rendering: pixelated;
        }

        div.cell.p2 {
            background-image: url("/static/robot2.png");
            background-size: 32px;
            image-rendering: pixelated;
        }

        div.cell.terminal {
            background-image: url("/static/terminal.png");
            background-size: 32px;
            image-rendering: pixelated;
        }

        #board>div.row>div.cell:hover {
            background-color: white;
        }
    </style>
</head>

<body>
    <div id="editor">
        <div id="board">
        </div>
        <div id="info">
            <h3>Legend</h3>
            <p>Pick one of these to later modify the grid</p>
            <div class="cell"></div> Empty (non-reachable) <br />
            <div class="cell walkable"></div> Walkable (regular floor) <br />
            <div class="cell walkable water"></div> Water (it kills you) <br />
            <div class="cell walkable p1"></div> Starting location player 1 <br />
            <div class="cell walkable p2"></div> Starting location player 2 <br />
            <div class="cell walkable terminal"></div> Exit location for any player <br />
            <input name="code" type="text" disabled value=""></input>
            <button id="try-this-map">Try this map</button>
            <h3></h3>
        </div>
    </div>
    <script>
        var selected = "cell walkable";
        function format(n) { return ("0" + n.toString(16)).slice(-2); };

        function encode_type_len(cells, type) {
            var code = "", len = 0;
            for (var cell of cells) {
                if (cell.className.startsWith(type)) {
                    code += cell.dataset.row + cell.dataset.col;
                    len += 1;
                };
            };
            return format(len) + code;
        };

        function decode_type_len(hash) {
            var len = parseInt(hash.slice(0, 2), 16);
            if (len == 0)
                return [];
            var rv = [];
            for (var i = 0; i < len; i++) {
                var pair = hash.slice(2 + 2 * i, 4 + 2 * i);
                rv.push([pair[0], pair[1]]);
            }
            return rv;
        };

        function update_code() {
            var input = document.getElementsByName("code")[0];
            var code = "";
            var cells = document.querySelectorAll("#board>div>div.cell");
            code += encode_type_len(cells, "cell walkable");
            code += encode_type_len(cells, "cell walkable water");
            code += encode_type_len(cells, "cell walkable p1");
            code += encode_type_len(cells, "cell walkable p2");
            code += encode_type_len(cells, "cell walkable terminal");
            input.value = code;
            var url = window.location.href;
            url = url.slice(0, url.lastIndexOf('#'));
            window.location.replace(url + '#' + code);
        };

        function hey(event) {
            event.target.className = selected;
            update_code();
        };

        function change_select(event) {
            selected = event.currentTarget.className;
        };

        function try_this_map() {
            var code = document.getElementsByName("code")[0].value;
            window.location.href = "/testbench/" + code;
        }
        var board = document.getElementById("board");

        for (var i = 0; i < 14; i++) {
            var row = document.createElement("div");
            row.className = "row";
            for (var j = 0; j < 16; j++) {
                var cell = document.createElement("div");
                cell.className = "cell";
                cell.addEventListener("click", hey);
                cell.dataset.row = i.toString(16);
                cell.dataset.col = j.toString(16);
                cell.id = 'cell-' + i.toString(16) + j.toString(16);
                row.appendChild(cell);
            };
            board.appendChild(row);
        };
        for (var cell of document.querySelectorAll("div#info>div.cell")) {
            cell.addEventListener("click", change_select);
        };

        function set_cells_with_type(cells, type) {
            for (var cell of cells) {
                var row = cell[0];
                var col = cell[1];
                document.getElementById('cell-' + row + col).className = type;
            }
        }
        function from_hash() {
            var hash = window.location.hash;
            if (hash.length != 0) {
                hash = hash.slice(1);
                var walkable = decode_type_len(hash);
                hash = hash.slice((walkable.length + 1) * 2);
                set_cells_with_type(walkable, "cell walkable");
                var cells = decode_type_len(hash);
                hash = hash.slice((cells.length + 1) * 2);
                set_cells_with_type(cells, "cell walkable water");
                var cells = decode_type_len(hash);
                hash = hash.slice((cells.length + 1) * 2);
                set_cells_with_type(cells, "cell walkable p1");
                var cells = decode_type_len(hash);
                hash = hash.slice((cells.length + 1) * 2);
                set_cells_with_type(cells, "cell walkable p2");
                var cells = decode_type_len(hash);
                hash = hash.slice((cells.length + 1) * 2);
                set_cells_with_type(cells, "cell walkable terminal");
                update_code();
            } else {
                update_code();
            }
        }
        from_hash();

        document.getElementById("try-this-map").addEventListener("click", try_this_map)

    </script>

</body>

</html>